# Pod Minimal Interface

Минимальный интерфейс для тестирования контрактов Pod.

## Установка

1. Установите зависимости (если еще не установлены):
```bash
cd pod-tma
pnpm install
```

2. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

3. Добавьте адрес задеплоенной фабрики контрактов в `.env`:
```env
VITE_POD_FACTORY_ADDRESS=EQD...your_factory_address_here
```

## Структура

### Новые файлы:

- `src/types/contract.ts` - TypeScript типы для контрактов
- `src/utils/contract.ts` - Утилиты для работы с контрактами (хеширование, форматирование)
- `src/composables/usePODContract.ts` - Composable для загрузки игр и работы с фабрикой (использует @tanstack/vue-query)
- `src/components/GameList.vue` - Компонент списка игр с фильтрами
- `src/components/GameCard.vue` - Компонент карточки игры
- `src/pages/PODPage.vue` - Главная страница интерфейса

### Технологии:

- **@tanstack/vue-query** - для управления состоянием данных, кеширования и автоматического обновления
- **@ton/core & @ton/ton** - для взаимодействия с TON блокчейном
- **TonConnect** - для подключения кошелька

### Функциональность:

#### 1. Список игр
- ✅ Отображение всех игр с пагинацией (по 10 игр)
- ✅ Фильтрация по статусу (все/ожидают оппонента/ожидают раскрытия)
- ✅ Автоматическая загрузка данных игр из контракта
- ✅ Отображение статистики фабрики
- ✅ Автоматическое кеширование и рефетчинг (vue-query)
- ✅ Infinite scroll для подгрузки старых игр

#### 2. Создание игры
- ✅ Выбор стороны монеты (орёл/решка)
- ✅ Указание ставки (с проверкой лимитов)
- ✅ Генерация секретного ключа
- ✅ Расчет хеша для зашифрованной ставки
- ⚠️ Отправка транзакции (TODO - требует интеграции с TonConnect)

#### 3. Присоединение к игре
- ✅ Выбор игры из списка
- ✅ Выбор стороны монеты
- ✅ Генерация секретного ключа
- ⚠️ Отправка транзакции (TODO)

#### 4. Раскрытие ставки
- ✅ Ввод секретного ключа
- ⚠️ Отправка транзакции для раскрытия (TODO)

#### 5. Отмена игры
- ✅ Кнопка отмены для создателя игры
- ⚠️ Отправка транзакции (TODO)

## Запуск

### Локальная разработка

```bash
# HTTP (только для десктопа)
pnpm dev

# HTTPS (для тестирования на мобильных)
pnpm dev:https
```

Откройте в браузере:
- Десктоп: `http://localhost:5173/pod`
- Мобильный: `https://localhost:5173/pod` (требует HTTPS!)

### Быстрый старт для тестирования

1. **Обязательно:** Используйте HTTPS для мобильных устройств:
   ```bash
   pnpm dev:https
   ```

2. **Для тестирования с телефона:** Используйте туннель (ngrok/cloudflare)
   ```bash
   # Установите cloudflared
   cloudflared tunnel --url https://localhost:5173
   ```

3. Обновите `public/tonconnect-manifest.json` с вашим доменом

4. Откройте маршрут `/pod` в приложении

⚠️ **Важно:** Android требует HTTPS для TON Connect! См. [DEPLOY.md](./DEPLOY.md)

## Деплой в продакшен

Подробная инструкция в [DEPLOY.md](./DEPLOY.md)

**Быстрый старт:**
```bash
# Vercel (проще всего)
npm i -g vercel
vercel --prod

# Или GitHub Pages
pnpm build
pnpm deploy
```

## Запуск

```bash
pnpm dev
```

Откройте в браузере `/pod` маршрут.

## Особенности реализации

### Vue Query интеграция

Composable `usePODContract` использует `@tanstack/vue-query` для управления данными:

- **statsQuery** - автоматически обновляется каждую минуту, кешируется на 30 секунд
- **configQuery** - кешируется на 5 минут (конфигурация редко меняется)
- **gamesQuery** - использует `useInfiniteQuery` для загрузки игр с пагинацией
  - Загружает новые игры сверху (самые свежие)
  - Поддерживает подгрузку старых игр через `loadMore()`
  - Автоматически обновляется каждые 10 секунд

Преимущества:
- Автоматическое кеширование запросов
- Оптимизация повторных запросов
- Фоновое обновление данных
- Управление состояниями загрузки и ошибок
- Легкая интеграция с UI компонентами

## TODO для полной функциональности

1. **Интеграция с TonConnect для отправки транзакций:**
   - Создание игры через `CreateGameMsg`
   - Присоединение к игре через `JoinGameMsg`
   - Раскрытие ставки через `OpenBidMsg`
   - Отмена игры через `CancelGameMsg`

2. **Хранение секретных ключей:**
   - Сохранение ключей в localStorage или IndexedDB
   - Автоматическое подставление ключа при раскрытии ставки

3. **Уведомления:**
   - Уведомления о новых играх
   - Уведомления о присоединении оппонента
   - Напоминания о раскрытии ставки

4. **Оптимизация:**
   - Кеширование данных игр
   - WebSocket для real-time обновлений (если доступно)

## Примечания

- Все функции отображения и валидации работают
- Транзакции пока выводятся в консоль и показывают alert
- Секретные ключи генерируются правильно и показываются пользователю
- Интерфейс адаптивный и работает на мобильных устройствах
